// namespace SpriteKind {
//     export const Sugar = SpriteKind.create()
//     export const Container = SpriteKind.create()
// }
controller.A.onEvent(ControllerButtonEvent.Pressed, function () {
    if (!(controller.B.isPressed()) && !(clicked)) {
        controller.moveSprite(mySprite, 40, 40)
        memX = mySprite.left + 2
        memY = mySprite.top + 2
    }
})
function spawnSugar () {
    timer.background(function () {
        for (let index = 0; index < maxSugar; index++) {
            scene.backgroundImage().setPixel(sugarSpawnX, sugarSpawnY, 1)
            sugarX.push(sugarSpawnX)
            sugarY.push(sugarSpawnY)
            pause(sugarDelay)
        }
        // sprite-based system; doesn't run well on hardware
        if (false) {
            for (let index = 0; index < maxSugar; index++) {
                sugarParticle = sprites.create(img`
                    1 
                    `, SpriteKind.Sugar)
                sugarParticle.setFlag(SpriteFlag.Ghost, true)
                sugarParticle.setFlag(SpriteFlag.AutoDestroy, true)
                sugarParticle.setPosition(sugarSpawnX, sugarSpawnY)
                pause(sugarDelay)
            }
        }
    })
}
screenEffects.createRenderable(1, function (image2) {
    if (clicked) {
        image2.drawLine(memX, memY, mySprite.left + 2, mySprite.top + 2, 13)
    }
})
controller.A.onEvent(ControllerButtonEvent.Released, function () {
    if (!(clicked)) {
        controller.moveSprite(mySprite, 75, 75)
        mySprite.setImage(img`
            . . 1 . . 
            . . 1 . . 
            1 1 . 1 1 
            . . 1 . . 
            . . 1 . . 
            `)
    }
})
controller.B.onEvent(ControllerButtonEvent.Pressed, function () {
    if (!(controller.A.isPressed())) {
        if (!(clicked)) {
            controller.moveSprite(mySprite, 50, 50)
            mySprite.setImage(img`
                . . 6 . . 
                . . 9 . . 
                6 9 . 9 6 
                . . 9 . . 
                . . 6 . . 
                `)
            clicked = true
            memX = mySprite.left + 2
            memY = mySprite.top + 2
        } else {
            controller.moveSprite(mySprite, 75, 75)
            mySprite.setImage(img`
                . . 1 . . 
                . . 1 . . 
                1 1 . 1 1 
                . . 1 . . 
                . . 1 . . 
                `)
            clicked = false
            scene.backgroundImage().drawLine(memX, memY, mySprite.left + 2, mySprite.top + 2, 7)
        }
    }
})
let moved = false
let y = 0
let x = 0
let sugarParticle; Sprite = null
let memY = 0
let memX = 0
let sugarDelay = 0
let maxSugar = 0
let sugarSpawnY = 0
let sugarSpawnX = 0
let clicked = false
let mySprite; Sprite = null
let sugarY; number = []
let sugarX; number = []
sugarX = []
sugarY = []
mySprite = sprites.create(img`
    . . 1 . . 
    . . 1 . . 
    1 1 . 1 1 
    . . 1 . . 
    . . 1 . . 
    `, SpriteKind.Player)
mySprite.z = 10
controller.moveSprite(mySprite, 75, 75)
mySprite.setFlag(SpriteFlag.StayInScreen, true)
clicked = false
scene.setBackgroundImage(img`
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    `)
sugarSpawnX = 60
sugarSpawnY = 10
maxSugar = 300
sugarDelay = 100
spawnSugar()
let mySprite2 = sprites.create(img`
    1 1 1 1 1 1 1 1 1 1 1 . . . . . 
    1 1 1 1 1 1 1 1 1 1 1 . . . . . 
    1 1 1 1 1 1 1 1 1 1 1 . 1 1 . . 
    1 1 1 1 1 1 1 1 1 1 1 1 . . 1 . 
    1 1 1 1 1 1 1 1 1 1 1 . . . . 1 
    1 1 1 1 1 1 1 1 1 1 1 . . . . 1 
    1 1 1 1 1 1 1 1 1 1 1 . . . . 1 
    1 1 1 1 1 1 1 1 1 1 1 . . . . 1 
    1 1 1 1 1 1 1 1 1 1 1 . . . . 1 
    1 1 1 1 1 1 1 1 1 1 1 . . . . 1 
    1 1 1 1 1 1 1 1 1 1 1 1 . . 1 . 
    1 1 1 1 1 1 1 1 1 1 1 . 1 1 . . 
    1 1 1 1 1 1 1 1 1 1 1 . . . . . 
    . 1 1 1 1 1 1 1 1 1 . . . . . . 
    `, SpriteKind.Container)
sprites.setDataNumber(mySprite2, "sugarLeft", 100)
mySprite2.setPosition(120, 100)
mySprite2 = sprites.create(img`
    1 1 1 1 1 1 1 1 1 1 1 . . . . . 
    1 1 1 1 1 1 1 1 1 1 1 . . . . . 
    1 1 1 1 1 1 1 1 1 1 1 . 1 1 . . 
    1 1 1 1 1 1 1 1 1 1 1 1 . . 1 . 
    1 1 1 1 1 1 1 1 1 1 1 . . . . 1 
    1 1 1 1 1 1 1 1 1 1 1 . . . . 1 
    1 1 1 1 1 1 1 1 1 1 1 . . . . 1 
    1 1 1 1 1 1 1 1 1 1 1 . . . . 1 
    1 1 1 1 1 1 1 1 1 1 1 . . . . 1 
    1 1 1 1 1 1 1 1 1 1 1 . . . . 1 
    1 1 1 1 1 1 1 1 1 1 1 1 . . 1 . 
    1 1 1 1 1 1 1 1 1 1 1 . 1 1 . . 
    1 1 1 1 1 1 1 1 1 1 1 . . . . . 
    . 1 1 1 1 1 1 1 1 1 . . . . . . 
    `, SpriteKind.Container)
sprites.setDataNumber(mySprite2, "sugarLeft", 100)
mySprite2.setPosition(60, 100)
for (let value of sprites.allOfKind(SpriteKind.Container)) {
    scene.backgroundImage().drawLine(value.left, value.top + 1, value.left + 10, value.top + 1, 3)
    value.sayText(sprites.readDataNumber(value, "sugarLeft"))
}
game.onUpdate(function () {
    mySprite.setPosition(Math.round(mySprite.x), Math.round(mySprite.y))
    if (controller.A.isPressed() && (!(controller.B.isPressed()) && !(clicked))) {
        mySprite.setImage(img`
            . . 6 . . 
            . . 7 . . 
            6 7 . 7 6 
            . . 7 . . 
            . . 6 . . 
            `)
        scene.backgroundImage().drawLine(memX, memY, mySprite.left + 2, mySprite.top + 2, 7)
        memX = mySprite.left + 2
        memY = mySprite.top + 2
    }
})
game.onUpdate(function () {
    for (let index = 0; index <= sugarX.length - 1; index++) {
        if (index <= sugarX.length - 1) {
            x = sugarX[index]
            y = sugarY[index]
            moved = false
            if (scene.backgroundImage().getPixel(x, y + 1) == 0) {
                scene.backgroundImage().setPixel(x, y, 0)
                sugarY[index] = y + 0.2
                y = sugarY[index]
                moved = true
            } else {
                if (scene.backgroundImage().getPixel(x, y + 1) == 3) {
                    sugarParticle = sprites.create(img`
                        1 
                        `, SpriteKind.Sugar)
                    sugarParticle.setPosition(x + 1, y + 1)
                    for (let value2 of sprites.allOfKind(SpriteKind.Container)) {
                        if (sugarParticle.overlapsWith(value2)) {
                            sprites.destroy(sugarParticle)
                            if (sprites.readDataNumber(value2, "sugarLeft") > 0) {
                                scene.backgroundImage().setPixel(x, y, 0)
                                sugarX.removeAt(index)
                                sugarY.removeAt(index)
                                sprites.changeDataNumberBy(value2, "sugarLeft", -1)
                                value2.sayText(sprites.readDataNumber(value2, "sugarLeft"))
                                index += -1
                            } else if (sprites.readDataNumber(value2, "sugarLeft") == 0) {
                                scene.backgroundImage().drawLine(value2.left, value2.top + 1, value2.left + 10, value2.top + 1, 1)
                            }
                            break;
                        }
                    }
                    break;
                }
            }
            if (Math.percentChance(15)) {
                if (scene.backgroundImage().getPixel(x - 1, y) == 0) {
                    if (scene.backgroundImage().getPixel(x, y - 1) != 0) {
                        if (!(moved)) {
                            scene.backgroundImage().setPixel(x, y, 0)
                            moved = true
                        }
                        sugarX[index] = x - 1
                        x = sugarX[index]
                    } else if (scene.backgroundImage().getPixel(x - 1, y + 1) == 0 && scene.backgroundImage().getPixel(x, y - 1) == 0) {
                        if (!(moved)) {
                            scene.backgroundImage().setPixel(x, y, 0)
                            moved = true
                        }
                        sugarX[index] = x - 1
                        x = sugarX[index]
                    }
                }
            }
            if (Math.percentChance(15)) {
                if (scene.backgroundImage().getPixel(x + 1, y) == 0) {
                    if (scene.backgroundImage().getPixel(x, y - 1) != 0) {
                        if (!(moved)) {
                            scene.backgroundImage().setPixel(x, y, 0)
                            moved = true
                        }
                        sugarX[index] = x + 1
                        x = sugarX[index]
                    } else if (scene.backgroundImage().getPixel(x + 1, y + 1) == 0 && scene.backgroundImage().getPixel(x, y - 1) == 0) {
                        if (!(moved)) {
                            scene.backgroundImage().setPixel(x, y, 0)
                            moved = true
                        }
                        sugarX[index] = x + 1
                        x = sugarX[index]
                    }
                }
            }
            scene.backgroundImage().setPixel(x, y, 1)
        }
    }
})
// sprite-based system; doesn't run well on hardware
game.onUpdate(function () {
    if (false) {
        for (let value of sprites.allOfKind(SpriteKind.Sugar)) {
            let sugarImg; Image = null
            if (scene.backgroundImage().getPixel(value.left, value.top + 1) == 0 && sugarImg.getPixel(value.left, value.top + 1) != 1) {
                sugarImg.setPixel(value.left, value.top, 0)
                value.y += 0.2
                sugarImg.setPixel(value.left, value.top, 1)
                if (sugarImg.getPixel(value.left, value.top + 1) == 3) {
                    for (let value2 of sprites.allOfKind(SpriteKind.Container)) {
                        value.setFlag(SpriteFlag.Ghost, false)
                        if (value.overlapsWith(value2)) {
                            if (sprites.readDataNumber(value2, "sugarLeft") > 0) {
                                sugarImg.setPixel(value.left, value.top, 0)
                                sprites.changeDataNumberBy(value2, "sugarLeft", -1)
                                sprites.destroy(value)
                                value2.sayText(sprites.readDataNumber(value2, "sugarLeft"))
                            } else if (sprites.readDataNumber(value2, "sugarLeft") == 0) {
                                sugarImg.drawLine(value2.left, value2.top + 1, value2.left + 10, value2.top + 1, 1)
                            }
                        }
                        value.setFlag(SpriteFlag.Ghost, true)
                    }
                }
            }
            if (Math.percentChance(10) && (scene.backgroundImage().getPixel(value.left - 1, value.top) == 0 && sugarImg.getPixel(value.left - 1, value.top) != 1)) {
                sugarImg.setPixel(value.left, value.top, 0)
                value.x += -1
                sugarImg.setPixel(value.left, value.top, 1)
            }
            if (Math.percentChance(10) && (scene.backgroundImage().getPixel(value.left + 1, value.top) == 0 && sugarImg.getPixel(value.left + 1, value.top) != 1)) {
                sugarImg.setPixel(value.left, value.top, 0)
                value.x += 1
                sugarImg.setPixel(value.left, value.top, 1)
            }
        }
    }
})
